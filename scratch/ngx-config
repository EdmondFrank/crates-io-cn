server {

    root /var/www/html;

    index index.html;

    listen 80 default_server;
    listen [::]:80 default_server;

    server_name <server_name>;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~* ^/api/v1/crates/(?<crate>[\w-]+)/(?<ver>\S+)/download {
        root /mirror_nfs/crates;
        default_type application/x-tar;
        try_files /$crate/$ver @fetch;
    }

    location @fetch {
        include /etc/nginx/proxy_params;
        add_header X-Mirror-Type fetch;
        proxy_pass http://127.0.0.1:3000/$crate/$ver/download/;
    }

    location ~ ^/crates.io-index(.*)$ {
        include /etc/nginx/fastcgi_params; # Include the default fastcgi configs
        fastcgi_param SCRIPT_FILENAME /usr/lib/git-core/git-http-backend; # Tells fastcgi to pass the request to the git http backend executable
        #fastcgi_param GIT_HTTP_EXPORT_ALL "";
        fastcgi_param GIT_PROJECT_ROOT /mirror_nfs; # /var/www/git is the location of all of your git repositories.
        fastcgi_param PATH_INFO /crates.io-index/.git$1; # Takes the capture group from our location directive and gives git that.
        fastcgi_pass  unix:/var/run/fcgiwrap.socket; # Pass the request to fastcgi
    }
}